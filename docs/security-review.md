# QQ Story 项目安全风险检查

本次快速检查聚焦后端（`server/`）实现，梳理了可能影响生产环境的风险点及缓解建议。

## 1. CORS 允许任意来源

- 默认 `ALLOWED_ORIGINS` 未配置或为 `*` 时，后端会接受任意 `Origin` 并返回成功的 CORS 预检响应，同时静态文件也被设置为 `Access-Control-Allow-Origin: *`。【F:server/src/config.js†L30-L36】【F:server/src/app.js†L24-L74】
- 影响：管理接口虽需密钥，但浏览器端若密钥泄露，任意站点都可直接跨域访问，扩大被滥用范围。
- 建议：生产环境明确填写允许的域名列表，并对静态资源服务关闭全量 CORS（除非确有 CDN/外链需求）。

## 2. 管理密钥为单一静态值

- 管理接口仅依赖一个固定的 `ADMIN_API_KEY` 请求头进行认证，缺乏轮换、失效和最小权限控制能力。【F:server/src/config.js†L24-L36】【F:server/src/middleware/apiKey.js†L3-L12】
- 影响：一旦密钥泄露（例如被保存在浏览器或日志中），攻击者可长期调用所有写接口，包括上传文件、删除数据等。
- 建议：改为按用户/设备发放可轮换的令牌，或至少增加密钥轮换、过期与使用审计；结合 IP 白名单/双因素校验进一步收窄滥用面。

## 3. 文本输入仅截断未做转义

- `sanitizeText` 只是裁剪字符串长度，没有进行 HTML/脚本字符转义，留言、时间轴等内容在存储和返回时保持原样。【F:server/src/utils/validators.js†L3-L30】【F:server/src/routes/comments.js†L60-L104】
- 影响：若前端在渲染时使用 `innerHTML` 或未进行输出转义，用户可提交包含脚本的内容导致存储型 XSS。
- 建议：在入库或响应前进行 HTML 转义/过滤（或在前端统一使用安全模板编码），同时为富文本场景采用白名单过滤库。

## 4. 上传文件类型与内容未校验且可被公开访问

- 上传接口接受任意 `data:` URL，将其原样写入磁盘，`determineExtension` 仅根据 MIME/文件名决定扩展名，并不会阻止可执行/HTML 文件；随后通过 `/uploads` 静态路由公开访问，响应头也允许任意来源获取。【F:server/src/services/fileService.js†L13-L91】【F:server/src/app.js†L67-L74】
- 影响：密钥泄露或内部账号被盗用时，攻击者可上传恶意 HTML/脚本文件实现存储型跨站或钓鱼；大型或异常文件也可能占满存储。
- 建议：
  - 对上传的 MIME 类型和文件大小做白名单校验，并在保存前重新探测 MIME；
  - 对可公开访问的上传目录启用内容安全策略或限制可执行类型；
  - 考虑将管理上传接口置于隔离网络或内网操作流中。

---

以上为初步静态检查结果，建议结合运行时日志、前端渲染方式与实际部署架构进一步验证并落实修复计划。
